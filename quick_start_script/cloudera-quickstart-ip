#! /usr/bin/env bash

# This script detects the IP address the eth0 interface is bound to and maps
# quickstart and quickstartcloudera to it. If eth0 should be used instead of
# lo and it is not configured before CM and CDH services start, this script
# should be run manually one it is configured, and the services restarted.

cat > /etc/hosts <<EOF
# This file is generated by /usr/bin/cloudera-quickstart-ip, which is invoked
# by /etc/init.d/cloudera-quickstart-init. If you wish to change the way that
# /etc/hosts is generated, you may edit /etc/init.d/cloudera-quickstart-init
# and hard-code a different IP address as a parameter to
# /usr/bin/cloudera-quickstart-ip, or you may comment out that line and manage
# /etc/hosts yourself.


EOF

IP=127.0.0.1

if [ -n "${1}" ]; then
    IP="${1}"
else
    for DEV in eth0 eth1 eth2; do
        if ip link show ${DEV}; then
            DEV_IP=`ip addr show "${DEV}" | grep inet | awk '{ print $2 }' | sed -e 's#/.*##'`
            if [ -n "${DEV_IP}" ]; then
                IP="${DEV_IP}"
                break
            fi
        fi
    done
fi

if [ "${IP}" == '127.0.0.1' ]; then
    cat >> /etc/hosts <<EOF
127.0.0.1	quickstart.cloudera	quickstart	localhost	localhost.domain

EOF
else
    cat >> /etc/hosts <<EOF
127.0.0.1	localhost	localhost.domain
${IP}	quickstart.cloudera	quickstart

EOF
fi

CONFIG=/var/lib/cloudera-quickstart/tutorial/js/config.js
sed -i -e "s/  \"manager_node_ip\": \".*\",/  \"manager_node_ip\": \"${IP}\",/" ${CONFIG}
sed -i -e "s/  \"worker_nodes_ip\": \\[ \".*\" \\],/  \"worker_nodes_ip\": \\[ \"${IP}\" \\],/" ${CONFIG}

